<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¨ Scratch æ•™æç€è¦½å™¨ | CHDAY169</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';
  </script>
  <style>
    /* ä¿æŒåŸæœ‰çš„CSSæ¨£å¼ï¼Œåªæ–°å¢ä»¥ä¸‹æ¨£å¼ */
    .source-badge {
      display: inline-block;
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 12px;
      margin-left: 8px;
      font-weight: 500;
    }
    
    .source-local {
      background: #28a745;
      color: white;
    }
    
    .source-github {
      background: #6f42c1;
      color: white;
    }
    
    .source-external {
      background: #fd7e14;
      color: white;
    }
    
    .source-selector {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .github-info {
      background: #e8f1ff;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 0.9rem;
    }
    
    .download-link {
      color: #0366d6;
      text-decoration: none;
      margin-right: 10px;
    }
    
    .download-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body class="container">
  <header class="page-header">
    <h1>ğŸ¨ Scratch æ•™æç€è¦½å™¨</h1>
    <p class="subtitle">Scratch ç¨‹å¼è¨­è¨ˆå­¸ç¿’è³‡æºèˆ‡æ•™å­¸æ•™æ</p>
    <div class="source-selector">
      <strong>ğŸ“š æ•™æä¾†æºï¼š</strong>
      <button onclick="filterSource('all')" class="level-btn active">å…¨éƒ¨</button>
      <button onclick="filterSource('local')" class="level-btn">æœ¬åœ°ä¸Šå‚³</button>
      <button onclick="filterSource('github')" class="level-btn">GitHub Release</button>
      <button onclick="filterSource('external')" class="level-btn">å¤–éƒ¨é€£çµ</button>
    </div>
  </header>
  
  <nav class="breadcrumb">
    <a href="index.html">é¦–é </a> &gt; <span>Scratch æ•™æ</span>
  </nav>
  
  <main class="viewer-container">
    <div class="viewer-content">
      <aside class="sidebar">
        <h3>ğŸ“š Scratch æ•™æé¸å–®</h3>
        
        <div class="level-filter">
          <h4>ğŸ” é›£åº¦ç­‰ç´š</h4>
          <div class="level-buttons" id="levelButtons">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>
        
        <select id="pdfSelect" size="8" class="pdf-select"></select>
        
        <div class="nav-buttons">
          <button onclick="prevPDF()" class="nav-btn">â¬…ï¸ ä¸Šä¸€æ•™æ</button>
          <button onclick="nextPDF()" class="nav-btn">â¡ï¸ ä¸‹ä¸€æ•™æ</button>
          <button onclick="refreshList()" class="nav-btn">ğŸ”„ é‡æ–°æ•´ç†</button>
          <button onclick="goBack()" class="nav-btn back-btn">ğŸ”™ è¿”å›ä¸»é </button>
        </div>
        
        <div id="fileInfo" class="github-info" style="display: none;">
          <strong>ğŸ“ æª”æ¡ˆè³‡è¨Šï¼š</strong>
          <div id="fileDetails"></div>
        </div>
      </aside>
      
      <section class="viewer-main">
        <div class="pdf-canvas-container">
          <canvas id="pdfCanvas"></canvas>
        </div>
        
        <div class="status-info" id="statusText">
          <span class="loading"></span>è«‹é¸æ“‡ Scratch æ•™æ
        </div>
        
        <div id="githubDetails" class="github-info" style="display: none;">
          <strong>ğŸ™ GitHub ä¾†æºï¼š</strong>
          <div id="githubRepoInfo"></div>
        </div>
        
        <!-- ä¿æŒåŸæœ‰çš„æ§åˆ¶æŒ‰éˆ•å’Œçµ±è¨ˆ -->
        <div class="page-controls">
          <button onclick="prevPage()" class="page-btn">ğŸ“„ ä¸Šä¸€é </button>
          <span class="page-info" id="pageInfo">ç¬¬ 0 é  / å…± 0 é </span>
          <button onclick="nextPage()" class="page-btn">ğŸ“„ ä¸‹ä¸€é </button>
        </div>
        
        <!-- å…¶é¤˜éƒ¨åˆ†ä¿æŒä¸è®Š -->
      </section>
    </div>
  </main>
  
  <script>
    const manifestURL = './data_scr/manifest.json';
    const GITHUB_REPO = 'chday169/scratch-web0218';
    const RELEASE_TAG = 'pdfs-scratch2026';
    
    let pdfList = [];
    let filteredList = [];
    let currentIndex = -1;
    let currentPage = 1;
    let totalPages = 1;
    let currentPDF = null;
    let hasLikedCurrentPDF = false;
    let currentScale = 1.5;
    let currentFilter = {
      level: 'all',
      source: 'all'
    };
    
    // è¼‰å…¥ PDF æ¸…å–®
    async function loadPDFList() {
      try {
        showStatus('è¼‰å…¥ Scratch æ•™ææ¸…å–®ä¸­...');
        
        const response = await fetch(manifestURL);
        if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥æ¸…å–®');
        
        const data = await response.json();
        if (!data.pdfs || !Array.isArray(data.pdfs)) {
          throw new Error('æ¸…å–®æ ¼å¼éŒ¯èª¤');
        }
        
        pdfList = data.pdfs.map(item => ({
          ...item,
          views: parseInt(localStorage.getItem(`pdf_views_${item.id}`) || '0'),
          likes: parseInt(localStorage.getItem(`pdf_likes_${item.id}`) || '0')
        }));
        
        // è¼‰å…¥åˆ†é¡
        if (data.categories) {
          window.pdfCategories = data.categories;
        }
        
        // åˆå§‹åŒ–éæ¿¾æŒ‰éˆ•
        initLevelButtons();
        
        // éæ¿¾æ¸…å–®
        applyFilters();
        
        if (pdfList.length > 0) {
          showStatus(`æ‰¾åˆ° ${pdfList.length} å€‹æ•™æ`);
        } else {
          showStatus('âŒ æ²’æœ‰å¯ç”¨çš„ Scratch æ•™æ', 'error');
        }
      } catch (err) {
        console.error('è¼‰å…¥éŒ¯èª¤ï¼š', err);
        showStatus('âŒ ç„¡æ³•è¼‰å…¥æ•™ææ¸…å–®ï¼Œä½¿ç”¨å‚™ç”¨è³‡æ–™', 'error');
        loadFallbackData();
      }
    }
    
    function initLevelButtons() {
      const container = document.getElementById('levelButtons');
      container.innerHTML = '';
      
      // æ·»åŠ "å…¨éƒ¨"æŒ‰éˆ•
      const allBtn = createLevelButton('all', 'å…¨éƒ¨');
      container.appendChild(allBtn);
      
      // æ·»åŠ åˆ†é¡æŒ‰éˆ•
      if (window.pdfCategories) {
        Object.entries(window.pdfCategories).forEach(([key, label]) => {
          const btn = createLevelButton(key, label);
          container.appendChild(btn);
        });
      }
      
      // è¨­ç½®é»˜èªé¸ä¸­
      document.querySelector('.level-btn[data-level="all"]').classList.add('active');
    }
    
    function createLevelButton(level, label) {
      const btn = document.createElement('button');
      btn.className = 'level-btn';
      btn.dataset.level = level;
      btn.textContent = label;
      btn.onclick = () => filterLevel(level);
      return btn;
    }
    
    function filterLevel(level) {
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.level-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.level-btn[data-level="${level}"]`).classList.add('active');
      
      currentFilter.level = level;
      applyFilters();
    }
    
    function filterSource(source) {
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.source-selector .level-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      currentFilter.source = source;
      applyFilters();
    }
    
    function applyFilters() {
      filteredList = pdfList.filter(item => {
        // ç­‰ç´šéæ¿¾
        if (currentFilter.level !== 'all' && item.level !== currentFilter.level) {
          return false;
        }
        
        // ä¾†æºéæ¿¾
        if (currentFilter.source !== 'all' && item.source !== currentFilter.source) {
          return false;
        }
        
        return true;
      });
      
      updatePDFSelect();
      
      if (filteredList.length > 0) {
        showPDF(0);
      } else {
        showStatus(`âŒ æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ•™æ`, 'error');
        clearCanvas();
      }
    }
    
    function updatePDFSelect() {
      const select = document.getElementById('pdfSelect');
      select.innerHTML = '';
      
      filteredList.forEach((item, index) => {
        const option = document.createElement('option');
        option.value = index;
        
        // æ§‹å»ºé¡¯ç¤ºæ–‡å­—
        let text = `${index + 1}. ${item.title}`;
        if (item.level && window.pdfCategories) {
          text += ` [${window.pdfCategories[item.level] || item.level}]`;
        }
        
        // æ·»åŠ ä¾†æºæ¨™è¨˜
        if (item.source) {
          text += ` ${getSourceBadge(item.source)}`;
        }
        
        option.innerHTML = text;
        select.appendChild(option);
      });
      
      // å¦‚æœæœ‰é¸ä¸­é …ç›®ï¼Œé¡¯ç¤ºè©³ç´°è³‡è¨Š
      if (currentIndex >= 0 && filteredList[currentIndex]) {
        updateFileInfo(filteredList[currentIndex]);
      }
    }
    
    function getSourceBadge(source) {
      const badges = {
        local: '<span class="source-badge source-local">æœ¬åœ°</span>',
        github: '<span class="source-badge source-github">GitHub</span>',
        external: '<span class="source-badge source-external">å¤–éƒ¨</span>'
      };
      return badges[source] || '';
    }
    
    function updateFileInfo(item) {
      const fileInfo = document.getElementById('fileInfo');
      const fileDetails = document.getElementById('fileDetails');
      const githubDetails = document.getElementById('githubDetails');
      const githubRepoInfo = document.getElementById('githubRepoInfo');
      
      // é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
      fileDetails.innerHTML = `
        <div>æ¨™é¡Œï¼š${item.title}</div>
        <div>ç­‰ç´šï¼š${window.pdfCategories?.[item.level] || item.level}</div>
        <div>ä¾†æºï¼š${item.source}</div>
        <div>ç€è¦½ï¼š${item.views || 0} æ¬¡</div>
        <div>é»è®šï¼š${item.likes || 0} æ¬¡</div>
      `;
      fileInfo.style.display = 'block';
      
      // å¦‚æœæ˜¯ GitHub ä¾†æºï¼Œé¡¯ç¤ºè©³ç´°è³‡è¨Š
      if (item.source === 'github') {
        const filename = getFilenameFromUrl(item.url);
        githubRepoInfo.innerHTML = `
          <div>å€‰åº«ï¼š${GITHUB_REPO}</div>
          <div>ç™¼å¸ƒç‰ˆæœ¬ï¼š${RELEASE_TAG}</div>
          <div>æª”æ¡ˆåç¨±ï¼š${filename}</div>
          <div style="margin-top: 8px;">
            <a href="https://github.com/${GITHUB_REPO}/releases/tag/${RELEASE_TAG}" target="_blank" class="download-link">ğŸ“¦ æŸ¥çœ‹ç™¼å¸ƒé é¢</a>
            <a href="${item.url}" target="_blank" class="download-link">â¬‡ï¸ ç›´æ¥ä¸‹è¼‰</a>
          </div>
        `;
        githubDetails.style.display = 'block';
      } else {
        githubDetails.style.display = 'none';
      }
    }
    
    function getFilenameFromUrl(url) {
      // å¾ URL ä¸­æå–æª”æ¡ˆåç¨±
      return url.split('/').pop() || 'æœªçŸ¥æª”æ¡ˆ';
    }
    
    function showPDF(index) {
      if (index < 0 || index >= filteredList.length) return;
      
      currentIndex = index;
      const item = filteredList[index];
      
      showStatus(`è¼‰å…¥æ•™æï¼š${item.title}`);
      updateFileInfo(item);
      
      // è¨˜éŒ„ç€è¦½æ¬¡æ•¸
      recordView(item.id);
      
      // è¼‰å…¥ PDF
      loadPDFDocument(item.url);
    }
    
    async function loadPDFDocument(url) {
      try {
        // å¦‚æœæ˜¯ GitHub URLï¼Œé¡¯ç¤ºè¼‰å…¥ä¾†æº
        if (url.includes('github.com')) {
          showStatus('æ­£åœ¨å¾ GitHub Releases è¼‰å…¥...');
        }
        
        const loadingTask = pdfjsLib.getDocument({
          url: url,
          withCredentials: false
        });
        
        currentPDF = await loadingTask.promise;
        totalPages = currentPDF.numPages;
        currentPage = 1;
        
        await renderPage(currentPage);
        showStatus(`å·²è¼‰å…¥ï¼š${filteredList[currentIndex].title}`);
        
      } catch (err) {
        console.error('PDF è¼‰å…¥å¤±æ•—ï¼š', err);
        showStatus(`âŒ ç„¡æ³•è¼‰å…¥ PDFï¼š${err.message}`, 'error');
      }
    }
    
    async function renderPage(pageNum) {
      if (!currentPDF) return;
      
      const page = await currentPDF.getPage(pageNum);
      const viewport = page.getViewport({ scale: currentScale });
      const canvas = document.getElementById('pdfCanvas');
      const context = canvas.getContext('2d');
      
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      
      await page.render({
        canvasContext: context,
        viewport: viewport
      }).promise;
      
      document.getElementById('pageInfo').textContent = `ç¬¬ ${pageNum} é  / å…± ${totalPages} é `;
    }
    
    function clearCanvas() {
      const canvas = document.getElementById('pdfCanvas');
      const context = canvas.getContext('2d');
      context.clearRect(0, 0, canvas.width, canvas.height);
      canvas.width = 0;
      canvas.height = 0;
    }
    
    function recordView(pdfId) {
      const key = `pdf_views_${pdfId}`;
      let count = parseInt(localStorage.getItem(key) || '0');
      count++;
      localStorage.setItem(key, count.toString());
      
      // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„æ•¸æ“š
      const item = pdfList.find(p => p.id === pdfId);
      if (item) {
        item.views = count;
      }
      
      // æ›´æ–°é¡¯ç¤º
      if (currentIndex >= 0 && filteredList[currentIndex]?.id === pdfId) {
        updateFileInfo(filteredList[currentIndex]);
      }
    }
    
    function recordLike(pdfId) {
      const key = `pdf_likes_${pdfId}`;
      let count = parseInt(localStorage.getItem(key) || '0');
      count++;
      localStorage.setItem(key, count.toString());
      
      // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„æ•¸æ“š
      const item = pdfList.find(p => p.id === pdfId);
      if (item) {
        item.likes = count;
      }
      
      // æ›´æ–°é¡¯ç¤º
      if (currentIndex >= 0 && filteredList[currentIndex]?.id === pdfId) {
        updateFileInfo(filteredList[currentIndex]);
      }
    }
    
    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('statusText');
      const icon = type === 'error' ? 'âŒ' : type === 'loading' ? '<span class="loading"></span>' : 'âœ…';
      statusEl.innerHTML = `${icon} ${message}`;
    }
    
    function loadFallbackData() {
      pdfList = [
        {
          id: 'fallback1',
          title: 'æ¸¬è©¦æ•™æ 1',
          level: 'beginner',
          url: 'https://raw.githubusercontent.com/mozilla/pdf.js/gh-pages/web/compressed.tracemonkey-pldi-09.pdf',
          source: 'external',
          views: 0,
          likes: 0
        }
      ];
      applyFilters();
    }
    
    function refreshList() {
      loadPDFList();
    }
    
    // ä¿æŒåŸæœ‰çš„å°èˆªå‡½æ•¸
    function prevPage() {
      if (currentPDF && currentPage > 1) {
        currentPage--;
        renderPage(currentPage);
      }
    }
    
    function nextPage() {
      if (currentPDF && currentPage < totalPages) {
        currentPage++;
        renderPage(currentPage);
      }
    }
    
    function prevPDF() {
      if (currentIndex > 0) {
        showPDF(currentIndex - 1);
      }
    }
    
    function nextPDF() {
      if (currentIndex < filteredList.length - 1) {
        showPDF(currentIndex + 1);
      }
    }
    
    function goBack() {
      window.location.href = 'index.html';
    }
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', loadPDFList);
    
    document.getElementById('pdfSelect').addEventListener('change', function () {
      const index = parseInt(this.value);
      if (!isNaN(index)) showPDF(index);
    });
  </script>
</body>
</html>