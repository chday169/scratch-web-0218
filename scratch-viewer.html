<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- å‡å°‘Firefoxé¡µé¢é¢„è§ˆé”™è¯¯ -->
  <meta name="robots" content="noimageindex, noarchive, nosnippet">
  <meta name="googlebot" content="noimageindex">
  
  <title>ğŸ¨ Scratch æ•™æç€è¦½å™¨ | CHDAY169</title>
  <link rel="stylesheet" href="assets/style.css">
  
  <!-- ä½¿ç”¨ç¨³å®šç‰ˆæœ¬çš„PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';
  </script>
  
  <style>
    /* å‡å°‘è‡ªå®šä¹‰æ ‡é¢˜æ ç›¸å…³çš„è­¦å‘Š */
    .titlebar {
      -moz-window-dragging: drag;
    }
    
    /* ä¿æŒåŸæœ‰çš„CSSæ¨£å¼ */
    .source-badge {
      display: inline-block;
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 12px;
      margin-left: 8px;
      font-weight: 500;
    }
    
    .source-local {
      background: #28a745;
      color: white;
    }
    
    .source-github {
      background: #6f42c1;
      color: white;
    }
    
    .source-external {
      background: #fd7e14;
      color: white;
    }
    
    .source-selector {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .github-info {
      background: #e8f1ff;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 0.9rem;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status-info {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 10px 0;
      min-height: 40px;
      display: flex;
      align-items: center;
    }
    
    .pdf-canvas-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: auto;
      max-height: 70vh;
      background: #f8f9fa;
    }
    
    .zoom-controls {
      margin-top: 10px;
      text-align: center;
    }
    
    .download-btn {
      display: inline-block;
      padding: 8px 16px;
      background: #6f42c1;
      color: white;
      border-radius: 6px;
      text-decoration: none;
      margin: 5px;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    
    .download-btn:hover {
      background: #5a32a3;
      text-decoration: none;
      color: white;
    }
    
    /* PDFæŸ¥çœ‹å™¨ç‹€æ…‹æŒ‡ç¤ºå™¨ */
    .viewer-status {
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body class="container">
  <header class="page-header">
    <h1>ğŸ¨ Scratch æ•™æç€è¦½å™¨</h1>
    <p class="subtitle">Scratch ç¨‹å¼è¨­è¨ˆå­¸ç¿’è³‡æºèˆ‡æ•™å­¸æ•™æ</p>
    <div class="source-selector">
      <strong>ğŸ“š æ•™æä¾†æºï¼š</strong>
      <button onclick="filterSource('all')" class="level-btn active">å…¨éƒ¨</button>
      <button onclick="filterSource('local')" class="level-btn">æœ¬åœ°ä¸Šå‚³</button>
      <button onclick="filterSource('github')" class="level-btn">GitHub Release</button>
    </div>
    
    <!-- ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div id="connectionStatus" class="viewer-status status-warning" style="display: none;">
      <strong>âš ï¸ æ³¨æ„ï¼š</strong> GitHub PDF å¯èƒ½éœ€è¦æ‰‹å‹•ä¸‹è¼‰
    </div>
  </header>
  
  <nav class="breadcrumb">
    <a href="index.html">é¦–é </a> &gt; <span>Scratch æ•™æ</span>
  </nav>
  
  <main class="viewer-container">
    <div class="viewer-content">
      <aside class="sidebar">
        <h3>ğŸ“š Scratch æ•™æé¸å–®</h3>
        
        <div class="level-filter">
          <h4>ğŸ” é›£åº¦ç­‰ç´š</h4>
          <div class="level-buttons" id="levelButtons">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>
        
        <select id="pdfSelect" size="12" class="pdf-select"></select>
        
        <div class="nav-buttons">
          <button onclick="prevPDF()" class="nav-btn">â¬…ï¸ ä¸Šä¸€æ•™æ</button>
          <button onclick="nextPDF()" class="nav-btn">â¡ï¸ ä¸‹ä¸€æ•™æ</button>
          <button onclick="refreshList()" class="nav-btn">ğŸ”„ é‡æ–°æ•´ç†</button>
          <button onclick="goBack()" class="nav-btn back-btn">ğŸ”™ è¿”å›ä¸»é </button>
        </div>
        
        <!-- ç›´æ¥ä¸‹è¼‰å€åŸŸ -->
        <div id="downloadPanel" class="github-info" style="display: none; margin-top: 20px;">
          <h4>ğŸ“¥ ä¸‹è¼‰é¸é …</h4>
          <div id="downloadButtons"></div>
        </div>
      </aside>
      
      <section class="viewer-main">
        <!-- PDF é è¦½å€åŸŸ -->
        <div class="pdf-canvas-container">
          <canvas id="pdfCanvas"></canvas>
        </div>
        
        <!-- ç‹€æ…‹è¨Šæ¯ -->
        <div class="viewer-status" id="viewerStatus">
          <span class="loading"></span>è«‹å¾å·¦å´é¸å–®é¸æ“‡æ•™æ
        </div>
        
        <!-- éŒ¯èª¤è¨Šæ¯å€åŸŸ -->
        <div id="errorMessage" class="viewer-status status-error" style="display: none;">
          <div id="errorContent"></div>
        </div>
        
        <!-- æˆåŠŸè¨Šæ¯å€åŸŸ -->
        <div id="successMessage" class="viewer-status status-success" style="display: none;">
          <div id="successContent"></div>
        </div>
        
        <!-- é é¢æ§åˆ¶ -->
        <div class="page-controls">
          <button onclick="prevPage()" class="page-btn">ğŸ“„ ä¸Šä¸€é </button>
          <span class="page-info" id="pageInfo">ç¬¬ 0 é  / å…± 0 é </span>
          <button onclick="nextPage()" class="page-btn">ğŸ“„ ä¸‹ä¸€é </button>
          <button onclick="downloadCurrentPDF()" class="download-btn">â¬‡ï¸ ä¸‹è¼‰æ­¤ PDF</button>
        </div>
        
        <!-- ç¸®æ”¾æ§åˆ¶ -->
        <div class="zoom-controls">
          <button onclick="zoomOut()" class="page-btn">ğŸ” -</button>
          <span class="page-info" id="zoomLevel">150%</span>
          <button onclick="zoomIn()" class="page-btn">ğŸ” +</button>
        </div>
      </section>
    </div>
  </main>
  
  <script>
    // é…ç½®å¸¸é‡
    const CONFIG = {
      manifestURL: './data_scr/manifest.json',
      githubRepo: 'chday169/scratch-web-0218',
      releaseTag: 'pdfs-scratch-new',
      maxRetryAttempts: 2,
      retryDelay: 1000,
      fallbackToDownload: true
    };
    
    // å…¨å±€è®Šé‡
    let pdfList = [];
    let filteredList = [];
    let currentIndex = -1;
    let currentPDF = null;
    let currentPage = 1;
    let totalPages = 0;
    let currentScale = 1.5;
    let currentFilter = { level: 'all', source: 'all' };
    let retryCount = 0;
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Scratch æ•™æç€è¦½å™¨åˆå§‹åŒ–...');
      setupEventListeners();
      loadPDFList();
      checkConnection();
    });
    
    // è¨­ç½®äº‹ä»¶ç›£è½å™¨
    function setupEventListeners() {
      document.getElementById('pdfSelect').addEventListener('change', function(e) {
        const index = parseInt(e.target.value);
        if (!isNaN(index) && index >= 0) {
          showPDF(index);
        }
      });
      
      // éµç›¤å¿«æ·éµ
      document.addEventListener('keydown', handleKeyDown);
      
      // é é¢å¯è¦‹æ€§è®ŠåŒ–
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden && currentPDF && currentPage > 0) {
          renderPage(currentPage);
        }
      });
    }
    
    // éµç›¤æ§åˆ¶
    function handleKeyDown(e) {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
        return;
      }
      
      switch(e.key) {
        case 'ArrowLeft':
          if (e.ctrlKey) prevPDF();
          else prevPage();
          e.preventDefault();
          break;
        case 'ArrowRight':
          if (e.ctrlKey) nextPDF();
          else nextPage();
          e.preventDefault();
          break;
        case '+':
        case '=':
          if (e.ctrlKey) {
            zoomIn();
            e.preventDefault();
          }
          break;
        case '-':
          if (e.ctrlKey) {
            zoomOut();
            e.preventDefault();
          }
          break;
        case 'd':
        case 'D':
          if (e.ctrlKey) {
            downloadCurrentPDF();
            e.preventDefault();
          }
          break;
      }
    }
    
    // æª¢æŸ¥é€£æ¥ç‹€æ…‹
    function checkConnection() {
      const statusEl = document.getElementById('connectionStatus');
      if (navigator.onLine) {
        statusEl.style.display = 'none';
      } else {
        statusEl.innerHTML = '<strong>âš ï¸ é›¢ç·šæ¨¡å¼ï¼š</strong> è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥';
        statusEl.style.display = 'block';
      }
    }
    
    // è¼‰å…¥ PDF æ¸…å–®
    async function loadPDFList() {
      try {
        showViewerStatus('è¼‰å…¥æ•™ææ¸…å–®ä¸­...', 'loading');
        
        const response = await fetchWithRetry(CONFIG.manifestURL);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // æª¢æŸ¥æ•¸æ“šæ ¼å¼
        if (!data || !data.pdfs || !Array.isArray(data.pdfs)) {
          throw new Error('æ¸…å–®æ ¼å¼éŒ¯èª¤ï¼Œç¼ºå°‘ pdfs é™£åˆ—');
        }
        
        // è™•ç† PDF åˆ—è¡¨
        pdfList = data.pdfs.map((item, idx) => ({
          ...item,
          id: item.id || `pdf-${idx}`,
          index: idx,
          views: parseInt(localStorage.getItem(`pdf_views_${item.id}`) || '0'),
          likes: parseInt(localStorage.getItem(`pdf_likes_${item.id}`) || '0')
        }));
        
        // è¼‰å…¥åˆ†é¡
        if (data.categories) {
          window.pdfCategories = data.categories;
        }
        
        // åˆå§‹åŒ–éæ¿¾æŒ‰éˆ•
        initLevelButtons();
        
        // æ‡‰ç”¨éæ¿¾å™¨
        applyFilters();
        
        if (pdfList.length > 0) {
          showViewerStatus(`æ‰¾åˆ° ${pdfList.length} å€‹æ•™æ`, 'success');
          showPDF(0);
        } else {
          showViewerStatus('âŒ æ²’æœ‰å¯ç”¨çš„æ•™æ', 'error');
        }
        
      } catch (err) {
        console.error('è¼‰å…¥æ¸…å–®å¤±æ•—:', err);
        showViewerStatus(`âŒ ç„¡æ³•è¼‰å…¥æ•™ææ¸…å–®: ${err.message}`, 'error');
        showError(`è«‹æª¢æŸ¥ manifest.json æª”æ¡ˆï¼š${err.message}`);
      }
    }
    
    // é‡è©¦æ©Ÿåˆ¶
    async function fetchWithRetry(url, options = {}, attempts = CONFIG.maxRetryAttempts) {
      for (let i = 0; i < attempts; i++) {
        try {
          const response = await fetch(url, options);
          if (response.ok) return response;
          
          if (i === attempts - 1) return response;
          
          await new Promise(resolve => setTimeout(resolve, CONFIG.retryDelay));
        } catch (err) {
          if (i === attempts - 1) throw err;
          await new Promise(resolve => setTimeout(resolve, CONFIG.retryDelay));
        }
      }
      throw new Error('æ‰€æœ‰é‡è©¦å˜—è©¦å¤±æ•—');
    }
    
    // åˆå§‹åŒ–ç­‰ç´šæŒ‰éˆ•
    function initLevelButtons() {
      const container = document.getElementById('levelButtons');
      container.innerHTML = '';
      
      // æ·»åŠ "å…¨éƒ¨"æŒ‰éˆ•
      container.appendChild(createFilterButton('all', 'å…¨éƒ¨'));
      
      // æ·»åŠ åˆ†é¡æŒ‰éˆ•
      if (window.pdfCategories) {
        Object.entries(window.pdfCategories).forEach(([key, label]) => {
          container.appendChild(createFilterButton(key, label));
        });
      } else {
        // è‡ªå‹•å¾ç¾æœ‰æ•¸æ“šæå–åˆ†é¡
        const levels = [...new Set(pdfList.map(item => item.level).filter(Boolean))];
        levels.forEach(level => {
          container.appendChild(createFilterButton(level, level));
        });
      }
    }
    
    function createFilterButton(level, label) {
      const btn = document.createElement('button');
      btn.className = 'level-btn';
      btn.dataset.level = level;
      btn.textContent = label;
      btn.onclick = () => {
        document.querySelectorAll('.level-buttons .level-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter.level = level;
        applyFilters();
      };
      
      if (level === 'all') {
        btn.classList.add('active');
      }
      
      return btn;
    }
    
    // ä¾†æºéæ¿¾
    function filterSource(source) {
      document.querySelectorAll('.source-selector .level-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      currentFilter.source = source;
      applyFilters();
    }
    
    // æ‡‰ç”¨éæ¿¾å™¨
    function applyFilters() {
      filteredList = pdfList.filter(item => {
        // ç­‰ç´šéæ¿¾
        if (currentFilter.level !== 'all' && item.level !== currentFilter.level) {
          return false;
        }
        
        // ä¾†æºéæ¿¾
        if (currentFilter.source !== 'all' && item.source !== currentFilter.source) {
          return false;
        }
        
        return true;
      });
      
      updatePDFSelect();
      updateDownloadPanel();
      
      if (filteredList.length > 0) {
        let newIndex = 0;
        
        // å˜—è©¦ä¿æŒç•¶å‰é¸æ“‡
        if (currentIndex >= 0 && currentIndex < pdfList.length) {
          const currentItem = pdfList[currentIndex];
          const filteredIndex = filteredList.findIndex(item => item.id === currentItem.id);
          if (filteredIndex >= 0) {
            newIndex = filteredIndex;
          }
        }
        
        showPDF(newIndex);
      } else {
        showViewerStatus('âŒ æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ•™æ', 'error');
        clearCanvas();
      }
    }
    
    // æ›´æ–°é¸å–®
    function updatePDFSelect() {
      const select = document.getElementById('pdfSelect');
      select.innerHTML = '';
      
      filteredList.forEach((item, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${index + 1}. ${item.title}`;
        
        // æ·»åŠ ä¾†æºæ¨™è¨˜
        if (item.source === 'github') {
          option.textContent += ' [GitHub]';
        } else if (item.source === 'local') {
          option.textContent += ' [æœ¬åœ°]';
        }
        
        select.appendChild(option);
      });
      
      if (currentIndex >= 0 && currentIndex < filteredList.length) {
        select.selectedIndex = currentIndex;
      }
    }
    
    // æ›´æ–°ä¸‹è¼‰é¢æ¿
    function updateDownloadPanel() {
      const panel = document.getElementById('downloadPanel');
      const buttons = document.getElementById('downloadButtons');
      
      if (filteredList.length === 0) {
        panel.style.display = 'none';
        return;
      }
      
      buttons.innerHTML = '';
      
      // ç‚ºæ¯å€‹PDFå‰µå»ºä¸‹è¼‰æŒ‰éˆ•
      filteredList.forEach((item, index) => {
        const btn = document.createElement('button');
        btn.className = 'download-btn';
        btn.textContent = `${index + 1}. ${item.title.substring(0, 20)}${item.title.length > 20 ? '...' : ''}`;
        btn.onclick = () => {
          downloadPDF(item);
          showPDF(index);
        };
        btn.title = `ä¸‹è¼‰: ${item.title}`;
        buttons.appendChild(btn);
        
        if (index < filteredList.length - 1) {
          buttons.appendChild(document.createElement('br'));
        }
      });
      
      panel.style.display = 'block';
    }
    
    // é¡¯ç¤ºPDF
    function showPDF(index) {
      if (index < 0 || index >= filteredList.length) return;
      
      currentIndex = index;
      const item = filteredList[index];
      
      // æ›´æ–°é¸å–®
      document.getElementById('pdfSelect').selectedIndex = index;
      
      // æ›´æ–°ç‹€æ…‹
      showViewerStatus(`è¼‰å…¥: ${item.title}`, 'loading');
      
      // è¨˜éŒ„ç€è¦½
      recordView(item.id);
      
      // è¼‰å…¥PDF
      loadPDFDocument(item);
    }
    
    // è¼‰å…¥PDFæ–‡æª”
    async function loadPDFDocument(item) {
      try {
        clearCanvas();
        retryCount = 0;
        
        // é¡¯ç¤ºè©³ç´°è³‡è¨Š
        showSuccess(`ğŸ“š ${item.title}<br>ğŸ“ ä¾†æº: ${item.source || 'æœªçŸ¥'}`);
        
        // å¦‚æœæ˜¯GitHubä¾†æºï¼Œé¡¯ç¤ºä¸‹è¼‰æç¤º
        if (item.source === 'github') {
          showViewerStatus('å˜—è©¦å¾ GitHub è¼‰å…¥...', 'loading');
          
          // å˜—è©¦å¤šç¨®æ–¹å¼è¼‰å…¥
          await tryLoadPDF(item.url, item);
          
        } else {
          // æœ¬åœ°æª”æ¡ˆ
          const loadingTask = pdfjsLib.getDocument({
            url: item.url,
            withCredentials: false
          });
          
          currentPDF = await loadingTask.promise;
          totalPages = currentPDF.numPages;
          currentPage = 1;
          
          await renderPage(currentPage);
          showViewerStatus(`âœ… è¼‰å…¥æˆåŠŸ: ${item.title}`, 'success');
        }
        
      } catch (err) {
        console.error('PDFè¼‰å…¥å¤±æ•—:', err);
        
        // é¡¯ç¤ºéŒ¯èª¤ä¸¦æä¾›ä¸‹è¼‰é¸é …
        showError(`
          âŒ ç„¡æ³•åœ¨ç€è¦½å™¨ä¸­é è¦½æ­¤PDF<br>
          ğŸ“¥ è«‹é»æ“Šã€Œä¸‹è¼‰æ­¤ PDFã€æŒ‰éˆ•ç²å–æª”æ¡ˆ<br>
          ${err.message || ''}
        `);
        
        showViewerStatus('âš ï¸ éœ€è¦æ‰‹å‹•ä¸‹è¼‰', 'warning');
      }
    }
    
    // å˜—è©¦å¤šç¨®æ–¹å¼è¼‰å…¥PDF
    async function tryLoadPDF(url, item) {
      const strategies = [
        // ç­–ç•¥1: ç›´æ¥è¼‰å…¥
        () => pdfjsLib.getDocument({
          url: url + '?t=' + Date.now(),
          withCredentials: false
        }).promise,
        
        // ç­–ç•¥2: é€šéfetchç²å–blob
        async () => {
          const response = await fetch(url, { cache: 'no-store' });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          
          const blob = await response.blob();
          const blobUrl = URL.createObjectURL(blob);
          
          const pdf = await pdfjsLib.getDocument({
            url: blobUrl,
            withCredentials: false
          }).promise;
          
          // æ¸…ç†blob URL
          setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
          return pdf;
        }
      ];
      
      let lastError = null;
      
      for (let i = 0; i < strategies.length; i++) {
        try {
          currentPDF = await strategies[i]();
          totalPages = currentPDF.numPages;
          currentPage = 1;
          
          await renderPage(currentPage);
          showViewerStatus(`âœ… GitHub PDF è¼‰å…¥æˆåŠŸ`, 'success');
          return;
          
        } catch (err) {
          lastError = err;
          console.log(`ç­–ç•¥ ${i + 1} å¤±æ•—:`, err);
          
          if (i < strategies.length - 1) {
            showViewerStatus(`å˜—è©¦æ–¹å¼ ${i + 1} å¤±æ•—ï¼Œå˜—è©¦ä¸‹ä¸€ç¨®...`, 'loading');
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        }
      }
      
      throw lastError || new Error('æ‰€æœ‰è¼‰å…¥æ–¹å¼éƒ½å¤±æ•—');
    }
    
    // æ¸²æŸ“é é¢
    async function renderPage(pageNum) {
      if (!currentPDF || pageNum < 1 || pageNum > totalPages) return;
      
      try {
        const page = await currentPDF.getPage(pageNum);
        const viewport = page.getViewport({ scale: currentScale });
        const canvas = document.getElementById('pdfCanvas');
        const context = canvas.getContext('2d');
        
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        await page.render({
          canvasContext: context,
          viewport: viewport
        }).promise;
        
        document.getElementById('pageInfo').textContent = `ç¬¬ ${pageNum} é  / å…± ${totalPages} é `;
        document.getElementById('zoomLevel').textContent = `${Math.round(currentScale * 100)}%`;
        
      } catch (err) {
        console.error('é é¢æ¸²æŸ“å¤±æ•—:', err);
        throw new Error('é é¢æ¸²æŸ“å¤±æ•—');
      }
    }
    
    // ä¸‹è¼‰PDF
    function downloadPDF(item) {
      if (!item || !item.url) return;
      
      try {
        const link = document.createElement('a');
        link.href = item.url;
        link.download = getFilenameFromUrl(item.url) || `${item.id}.pdf`;
        link.target = '_blank';
        
        // è§¸ç™¼ä¸‹è¼‰
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showSuccess(`âœ… é–‹å§‹ä¸‹è¼‰: ${item.title}`);
        
      } catch (err) {
        console.error('ä¸‹è¼‰å¤±æ•—:', err);
        showError(`âŒ ä¸‹è¼‰å¤±æ•—: ${err.message}`);
      }
    }
    
    function downloadCurrentPDF() {
      if (currentIndex >= 0 && currentIndex < filteredList.length) {
        downloadPDF(filteredList[currentIndex]);
      }
    }
    
    // è¼”åŠ©å‡½æ•¸
    function getFilenameFromUrl(url) {
      if (!url) return '';
      const filename = url.split('/').pop();
      return filename.split('?')[0];
    }
    
    function recordView(pdfId) {
      const key = `pdf_views_${pdfId}`;
      let count = parseInt(localStorage.getItem(key) || '0');
      count++;
      localStorage.setItem(key, count.toString());
    }
    
    function clearCanvas() {
      const canvas = document.getElementById('pdfCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      canvas.width = 0;
      canvas.height = 0;
    }
    
    // ç‹€æ…‹é¡¯ç¤ºå‡½æ•¸
    function showViewerStatus(message, type = 'info') {
      const el = document.getElementById('viewerStatus');
      let icon = '';
      
      switch(type) {
        case 'error': icon = 'âŒ '; break;
        case 'loading': icon = '<span class="loading"></span>'; break;
        case 'success': icon = 'âœ… '; break;
        case 'warning': icon = 'âš ï¸ '; break;
        default: icon = 'â„¹ï¸ ';
      }
      
      el.innerHTML = `${icon} ${message}`;
      el.className = `viewer-status status-${type}`;
      el.style.display = 'block';
      
      // éš±è—å…¶ä»–è¨Šæ¯
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }
    
    function showError(message) {
      const el = document.getElementById('errorMessage');
      const content = document.getElementById('errorContent');
      content.innerHTML = message;
      el.style.display = 'block';
    }
    
    function showSuccess(message) {
      const el = document.getElementById('successMessage');
      const content = document.getElementById('successContent');
      content.innerHTML = message;
      el.style.display = 'block';
    }
    
    // å°èˆªå‡½æ•¸
    function prevPage() {
      if (currentPDF && currentPage > 1) {
        currentPage--;
        renderPage(currentPage);
      }
    }
    
    function nextPage() {
      if (currentPDF && currentPage < totalPages) {
        currentPage++;
        renderPage(currentPage);
      }
    }
    
    function prevPDF() {
      if (currentIndex > 0) {
        showPDF(currentIndex - 1);
      }
    }
    
    function nextPDF() {
      if (currentIndex < filteredList.length - 1) {
        showPDF(currentIndex + 1);
      }
    }
    
    function refreshList() {
      loadPDFList();
    }
    
    function goBack() {
      window.location.href = 'index.html';
    }
    
    // ç¸®æ”¾åŠŸèƒ½
    function zoomIn() {
      if (currentScale < 3.0) {
        currentScale += 0.1;
        if (currentPDF && currentPage) {
          renderPage(currentPage);
        }
      }
    }
    
    function zoomOut() {
      if (currentScale > 0.5) {
        currentScale -= 0.1;
        if (currentPDF && currentPage) {
          renderPage(currentPage);
        }
      }
    }
    
    // ç¶²è·¯ç‹€æ…‹ç›£è½
    window.addEventListener('online', checkConnection);
    window.addEventListener('offline', checkConnection);
    
  </script>
</body>
</html>